add_executable(${PROJECT_NAME})

# Source files
target_sources(${PROJECT_NAME} PRIVATE
  startup/start.s
  startup/vector_table.c
  src/main.cpp
)

# Include directories
target_include_directories(${PROJECT_NAME} PRIVATE
  startup/
  include/
)

# Linker script
set(LINKER_SCRIPT "${CMAKE_CURRENT_SOURCE_DIR}/linker/ch32v305rb.ld")
target_link_options(${PROJECT_NAME} PRIVATE
  -T ${LINKER_SCRIPT}
)

# Post Build Steps

# Generate disassembly
add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
  COMMAND ${CMAKE_OBJDUMP} -D -S $<TARGET_FILE:${PROJECT_NAME}> > ${PROJECT_NAME}.lst
  COMMENT "Generating disassembly listing"
  VERBATIM
)

# Generate binary file for flashing
add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
  COMMAND ${CMAKE_OBJCOPY} -O binary -R .bss -R .stack $<TARGET_FILE:${PROJECT_NAME}> ${PROJECT_NAME}.bin
  COMMENT "Generating binary file"
  VERBATIM
)

# Print size information
add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
  COMMAND ${CMAKE_OBJDUMP} -h $<TARGET_FILE:${PROJECT_NAME}>
  COMMENT "Memory usage:"
  VERBATIM
)
